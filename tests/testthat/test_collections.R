context("collections - insert")

con <- NULL
if(is_test_db_reachable()) {
  con <- connect_to_test_db()
}


# db_collection_add -------------------------------------------------------


# TODO: Tests for db_call_function args

test_with_fresh_db(con, "db_collection_add returns OK", {
  result <- db_collection_add(con,
                              "tests first",
                              "ts4")

  expect_is(result, "list")
  expect_named(result, c("status", "message"))
  expect_equal(result$status, "ok")
})

test_with_fresh_db(con, "db_collection_add warns if keys not in catalog", {
  expect_warning(db_collection_add(con,
                                   "tests first",
                                   "tsx"), "specific collection")
})

test_with_fresh_db(con, "db_collection_add returns warning keys not in catalog", {
  result <- suppressWarnings(db_collection_add(con,
                              "tests first",
                              "tsx"))

  expect_is(result, "list")
  expect_named(result, c("status", "message", "invalid_keys"))
  expect_equal(result$status, "warning")
  expect_equal(result$invalid_keys, "tsx")
})

test_with_fresh_db(con, "db_collection_add add keys to existing", {
  db_collection_add(con, "tests first", "vts1", user = "test")

  result <- dbGetQuery(con, "SELECT * FROM timeseries.collect_catalog
                             JOIN timeseries.collections
                             ON timeseries.collect_catalog.id = timeseries.collections.id
                             AND name = 'tests first'")

  expect_equal(nrow(result), 4)
  expect_setequal(result$ts_key, c("ts1", "ts2", "ts3", "vts1"))
})

test_with_fresh_db(con, "db_collection_add add new collection & keys", {
  db_collection_add(con,
                    "tests new",
                    c("vts1", "vts2"),
                    user = "test",
                    description = "a collection generated by a test")

  collections_result <- dbGetQuery(con, "SELECT * FROM timeseries.collections
                                         WHERE name = 'tests new'
                                         AND owner = 'test'")

  expect_equal(collections_result[, -1], data.frame(
    name = "tests new",
    owner = "test",
    description = "a collection generated by a test",
    stringsAsFactors = FALSE
  ))

  collect_catalog_result <- dbGetQuery(con, "SELECT timeseries.collections.id, ts_key FROM timeseries.collect_catalog
                                       JOIN timeseries.collections
                                       ON timeseries.collect_catalog.id = timeseries.collections.id
                                       AND name = 'tests new'")

  expect_equal(collect_catalog_result, data.frame(
    id = collections_result$id,
    ts_key = c("vts1", "vts2"),
    stringsAsFactors = FALSE
  ))
})
